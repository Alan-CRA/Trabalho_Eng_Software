{% extends "base.html" %}
{% block title %}{{ filme.nome }} • CineRecomenda{% endblock %}
{% block content %}
<div class="grid grid-cols-1 gap-10 md:grid-cols-3">
  <!-- Poster -->
  <div>
    <div class="overflow-hidden rounded-2xl border border-white/10 bg-[#121317] shadow-[0_8px_24px_rgba(0,0,0,.35)]">
      {% if filme.poster_path %}
      <img src="{{ IMG }}w500{{ filme.poster_path }}" alt="{{ filme.nome }}" class="w-full object-cover" />
      {% else %}
      <div class="grid h-full place-items-center px-6 py-12 text-sm text-zinc-500">Sem imagem disponível</div>
      {% endif %}
    </div>
  </div>

  <!-- Informações do Filme -->
  <div class="md:col-span-2 space-y-6">
    <div class="flex items-start justify-between gap-4">
      <h1 class="text-3xl font-bold text-zinc-50 md:text-4xl">{{ filme.nome }}</h1>
      {% if user.is_authenticated %}
      <a href="{% url 'filmes:favoritar' filme.id %}"
        class="flex-shrink-0 p-2 rounded-full transition-all hover:scale-110 {% if is_favorito %}bg-rose-500/20 text-rose-500{% else %}bg-white/5 text-zinc-400 hover:text-rose-400{% endif %}"
        title="{% if is_favorito %}Remover dos favoritos{% else %}Adicionar aos favoritos{% endif %}">
        <svg class="h-7 w-7" viewBox="0 0 24 24" {% if is_favorito %}fill="currentColor" {% else %}fill="none"
          stroke="currentColor" stroke-width="1.5" {% endif %}>
          <path
            d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"
            stroke-linecap="round" stroke-linejoin="round" />
        </svg>
      </a>
      {% endif %}
    </div>
    <div class="mt-4 flex flex-wrap items-center gap-4 text-sm text-zinc-300">
      <span class="flex items-center gap-2">
        <svg class="h-4 w-4 text-rose-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="m12 3 2.1 6.47H21l-4.8 3.49L18.3 21 12 16.98 5.7 21l1.8-8.04L2 9.47h6.9L12 3Z" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        TMDB {{ filme.nota_media|default:"—" }}
      </span>
      {% if media_avaliacoes %}
      <span class="flex items-center gap-2">
        <svg class="h-4 w-4 text-amber-400" viewBox="0 0 24 24" fill="currentColor">
          <path d="m12 3 2.1 6.47H21l-4.8 3.49L18.3 21 12 16.98 5.7 21l1.8-8.04L2 9.47h6.9L12 3Z" />
        </svg>
        Usuários {{ media_avaliacoes|floatformat:1 }} ({{ total_avaliacoes }})
      </span>
      {% endif %}
      <span class="flex items-center gap-2">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <path d="M6 3h12a2 2 0 0 1 2 2v14l-4-3-4 3-4-3-4 3V5a2 2 0 0 1 2-2Z" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        {{ filme.lancamento|default:"—" }}
      </span>
      <span class="flex items-center gap-2">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="12" cy="12" r="9" />
          <path d="M12 7v5l3 2" stroke-linecap="round" stroke-linejoin="round" />
        </svg>
        {{ filme.tempo|default:"—" }} min
      </span>
    </div>

    {% if filme.sinopse %}
    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-zinc-100">Sinopse</h2>
      <p class="text-base leading-relaxed text-zinc-300">{{ filme.sinopse }}</p>
    </div>
    {% endif %}

    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-zinc-100">Gêneros</h2>
      <div class="flex flex-wrap gap-2">
        {% for g in filme.genero.all %}
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-zinc-200">{{ g.nome }}</span>
        {% empty %}
        <span class="text-sm text-zinc-500">—</span>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-zinc-100">Elenco</h2>
      <div class="flex flex-wrap gap-2">
        {% for a in filme.atores.all %}
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-zinc-200">{{ a.nome }}</span>
        {% empty %}
        <span class="text-sm text-zinc-500">—</span>
        {% endfor %}
      </div>
    </div>

    <div class="space-y-3">
      <h2 class="text-lg font-semibold text-zinc-100">Onde assistir</h2>
      <div class="flex flex-wrap gap-2">
        {% for s in filme.streaming.all %}
        <span class="px-3 py-1 rounded-full bg-white/5 border border-white/10 text-xs text-zinc-200">{{ s.nome }}</span>
        {% empty %}
        <span class="text-sm text-zinc-500">—</span>
        {% endfor %}
      </div>
    </div>

    <!-- SEÇÃO DE AVALIAÇÃO -->
    <div class="space-y-4 pt-4 border-t border-white/10">
      <h2 class="text-lg font-semibold text-zinc-100 flex items-center gap-2">
        <svg class="h-5 w-5 text-amber-400" fill="currentColor" viewBox="0 0 24 24">
          <path d="m12 3 2.1 6.47H21l-4.8 3.49L18.3 21 12 16.98 5.7 21l1.8-8.04L2 9.47h6.9L12 3Z" />
        </svg>
        Sua Avaliação
      </h2>

      {% if user.is_authenticated %}
      <!-- Formulário de Avaliação -->
      <form method="post" action="{% url 'filmes:avaliar' filme.id %}" class="space-y-4">
        {% csrf_token %}

        <!-- Estrelas interativas -->
        <div class="flex items-center gap-1" id="star-rating">
          {% for i in estrelas_range %}
          <button type="button" data-rating="{{ i }}"
            class="star-btn p-1 transition-transform hover:scale-110 focus:outline-none" aria-label="Nota {{ i }}">
            <svg
              class="h-8 w-8 {% if avaliacao_usuario and avaliacao_usuario.nota >= i %}text-amber-400{% else %}text-zinc-600{% endif %} transition-colors"
              fill="currentColor" viewBox="0 0 24 24">
              <path d="m12 3 2.1 6.47H21l-4.8 3.49L18.3 21 12 16.98 5.7 21l1.8-8.04L2 9.47h6.9L12 3Z" />
            </svg>
          </button>
          {% endfor %}
          <span id="rating-display" class="ml-3 text-lg font-semibold text-zinc-200">
            {% if avaliacao_usuario %}{{ avaliacao_usuario.nota }}/10{% else %}Clique para avaliar{% endif %}
          </span>
        </div>
        <input type="hidden" name="nota" id="nota-input" value="{{ avaliacao_usuario.nota|default:'' }}">

        <!-- Comentário -->
        <div>
          {{ form.comentario }}
        </div>

        <!-- Botões -->
        <div class="flex flex-wrap gap-3">
          <button type="submit"
            class="inline-flex items-center gap-2 rounded-full bg-amber-500 hover:bg-amber-600 px-5 py-2 text-sm font-medium text-white shadow transition focus:outline-none focus:ring-2 focus:ring-amber-400/40">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            {% if avaliacao_usuario %}Atualizar Avaliação{% else %}Enviar Avaliação{% endif %}
          </button>
          {% if avaliacao_usuario %}
          <a href="{% url 'filmes:excluir_avaliacao' filme.id %}"
            onclick="return confirm('Tem certeza que deseja remover sua avaliação?')"
            class="inline-flex items-center gap-2 rounded-full border border-rose-500/30 bg-rose-500/10 px-5 py-2 text-sm font-medium text-rose-400 transition hover:bg-rose-500/20 focus:outline-none focus:ring-2 focus:ring-rose-400/40">
            <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Remover
          </a>
          {% endif %}
        </div>
      </form>
      {% else %}
      <!-- Usuário não logado -->
      <div class="rounded-xl border border-white/10 bg-white/5 p-6 text-center">
        <p class="text-zinc-400 mb-4">Faça login para avaliar este filme</p>
        <a href="{% url 'contas:entrar' %}?next={{ request.path }}%3Fid={{ filme.tmdb_id }}"
          class="inline-flex items-center gap-2 rounded-full bg-rose-600 hover:bg-rose-700 px-5 py-2 text-sm font-medium text-white shadow transition">
          Entrar para Avaliar
        </a>
      </div>
      {% endif %}
    </div>

    <!-- AVALIAÇÕES DE OUTROS USUÁRIOS -->
    {% if avaliacoes %}
    <div class="space-y-4 pt-4 border-t border-white/10">
      <h2 class="text-lg font-semibold text-zinc-100">Avaliações dos Usuários</h2>
      <div class="space-y-4">
        {% for av in avaliacoes %}
        <div class="rounded-xl border border-white/10 bg-white/5 p-4">
          <div class="flex items-start justify-between">
            <div class="flex items-center gap-3">
              <div
                class="grid h-10 w-10 place-items-center rounded-full bg-gradient-to-br from-rose-500 to-rose-700 text-sm font-bold text-white">
                {{ av.user.username|slice:":1"|upper }}
              </div>
              <div>
                <p class="font-medium text-zinc-100">{{ av.user.username }}</p>
                <p class="text-xs text-zinc-500">{{ av.criado_em|date:"d/m/Y" }}</p>
              </div>
            </div>
            <div class="flex items-center gap-1">
              <svg class="h-5 w-5 text-amber-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="m12 3 2.1 6.47H21l-4.8 3.49L18.3 21 12 16.98 5.7 21l1.8-8.04L2 9.47h6.9L12 3Z" />
              </svg>
              <span class="font-semibold text-zinc-100">{{ av.nota }}/10</span>
            </div>
          </div>
          {% if av.comentario %}
          <p class="mt-3 text-sm text-zinc-300">{{ av.comentario }}</p>
          {% endif %}
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- Botões de navegação -->
    <div class="flex flex-wrap gap-3 pt-2">
      <a href="{% url 'pages:home' %}"
        class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-5 py-2 text-sm font-medium text-zinc-100 transition hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-rose-400/40">←
        Voltar</a>
      <a href="{% url 'filmes:lista_filmes' %}?q={{ filme.nome|urlencode }}"
        class="inline-flex items-center gap-2 rounded-full bg-rose-600 px-5 py-2 text-sm font-medium text-white shadow transition hover:bg-rose-700 focus:outline-none focus:ring-2 focus:ring-rose-400/40">Buscar
        similares</a>
    </div>
  </div>
</div>

<!-- JavaScript para as estrelas interativas -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const stars = document.querySelectorAll('.star-btn');
    const notaInput = document.getElementById('nota-input');
    const ratingDisplay = document.getElementById('rating-display');

    stars.forEach(star => {
      star.addEventListener('click', function () {
        const rating = parseInt(this.dataset.rating);
        notaInput.value = rating;
        ratingDisplay.textContent = rating + '/10';

        // Atualiza visual das estrelas
        stars.forEach((s, index) => {
          const svg = s.querySelector('svg');
          if (index < rating) {
            svg.classList.remove('text-zinc-600');
            svg.classList.add('text-amber-400');
          } else {
            svg.classList.remove('text-amber-400');
            svg.classList.add('text-zinc-600');
          }
        });
      });

      // Hover effect
      star.addEventListener('mouseenter', function () {
        const rating = parseInt(this.dataset.rating);
        stars.forEach((s, index) => {
          const svg = s.querySelector('svg');
          if (index < rating) {
            svg.classList.add('text-amber-300');
          }
        });
      });

      star.addEventListener('mouseleave', function () {
        const currentRating = parseInt(notaInput.value) || 0;
        stars.forEach((s, index) => {
          const svg = s.querySelector('svg');
          svg.classList.remove('text-amber-300');
          if (index < currentRating) {
            svg.classList.remove('text-zinc-600');
            svg.classList.add('text-amber-400');
          } else {
            svg.classList.remove('text-amber-400');
            svg.classList.add('text-zinc-600');
          }
        });
      });
    });
  });
</script>
{% endblock %}